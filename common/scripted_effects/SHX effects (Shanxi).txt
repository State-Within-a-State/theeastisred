##############################################
### By Suzuha, Chiang Kai-shrek, and sSeSs ###
##############################################

####################
#####- Index - #####
####################

##Political
#- Balance of Power Effects
#- Victory Effects

##Beijing Investment
#- QIE Negotiations and Zhifeng
#- Beijing Influence Levels
#- Misc Beijing Effects

##Warfare
#- Manchu Coup
#- Zhifeng War
#- Suiyuan Effects

##Endgame Effects

####################
###- Political - ###
####################

###- Balance of Power - ###

#Maintenance Note: It is worth remembering that Yan is negative, Feng is positive.

SHX_change_pop_effect = {
	set_temp_variable = { SHX_pop_change_var = SHX_bop_change_var }
	if = {
		limit = { has_active_mission = SHX_looming_gmj_coup }
		multiply_temp_variable = { SHX_pop_change_var = 0.25 } #Quarter it
	}
	else = {
		multiply_temp_variable = { SHX_pop_change_var = 0.10 } #Tenth it so post power struggle its not as easy to get 100%
	}
	set_temp_variable = { SHX_pop_change_neg_var = SHX_pop_change_var }
	multiply_temp_variable = { SHX_pop_change_neg_var = -1 } #Invert it
	add_popularity = {
		ideology = authoritarian_democrat
		popularity = SHX_pop_change_var
	}
	add_popularity = {
		ideology = paternal_autocrat
		popularity = SHX_pop_change_neg_var
	}
}

SHX_change_timeout_effect = {
	set_temp_variable = { SHX_timeout_change_var = SHX_bop_change_var }
	multiply_temp_variable = { SHX_timeout_change_var = 100 } #Turn it into a whole number
	multiply_temp_variable = { SHX_timeout_change_var = -4 } #Double it and invert it
	add_days_mission_timeout = {
		mission = SHX_looming_gmj_coup
		days = SHX_timeout_change_var
	}
}

SHX_strengthen_yan_small = {
	set_temp_variable = { SHX_bop_change_var = -0.05 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.05
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_small_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +5 - overall decrease by -5 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

SHX_strengthen_yan_medium = {
	set_temp_variable = { SHX_bop_change_var = -0.15 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.15
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_medium_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +15 - overall decrease by -15 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

SHX_strengthen_yan_large = {
	set_temp_variable = { SHX_bop_change_var = -0.25 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.25
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_large_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +25 - overall decrease by -25 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

SHX_strengthen_feng_small = {
	set_temp_variable = { SHX_bop_change_var = 0.05 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.05
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_small_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +5 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

SHX_strengthen_feng_medium = {
	set_temp_variable = { SHX_bop_change_var = 0.15 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.15
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_medium_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +15 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

SHX_strengthen_feng_large = {
	set_temp_variable = { SHX_bop_change_var = 0.25 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.25
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_large_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +25 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

###- Victory Effects -###

SHX_yan_victory_effect = {

	set_temp_variable = { yan_distance_from_victory_temp_variable = power_balance_value } #Ranges from 0 to 1
	if = {
		limit = { SHX_yan_is_winning_trigger = yes }
		divide_temp_variable = { yan_distance_from_victory_temp_variable = 2 } #Ranges now from 0 to 0.5
	}
	else_if = {
		limit = { SHX_feng_is_winning_trigger = yes }
		divide_temp_variable = { yan_distance_from_victory_temp_variable = -2 } #Ranges now from 0 to -0.5
	}
	else = {
		set_temp_variable = { yan_distance_from_victory_temp_variable = -0.05 }
	}
	add_stability = yan_distance_from_victory_temp_variable

	remove_mission = SHX_looming_gmj_coup
	remove_ideas = SHX_guominjun_unrest_idea
	remove_power_balance = { id = SHX_power_balance }

	country_event = { id = shx_powerstruggle.3 days = 1 } #Order Prevails in Shaanxi!

	hidden_effect = {
		QIE = {
			country_event = { id = shx_zhifeng.1 days = 7 } #QIE is informed of outcome of Yan power struggle
		}
	}
	mark_focus_tree_layout_dirty = yes # just in case any allow branch focuses are added to Yan side
}

SHX_feng_victory_effect = {

	set_temp_variable = { feng_distance_from_victory_temp_variable = power_balance_value } #Ranges from 0 to 1
	if = {
		limit = { SHX_yan_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = -2 } #Ranges now from 0 to -0.5
	}
	else_if = {
		limit = { SHX_feng_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = 2 } #Ranges now from 0 to 0.5
	}
	else = {
		set_temp_variable = { feng_distance_from_victory_temp_variable = -0.05 }
	}
	add_stability = feng_distance_from_victory_temp_variable

	remove_mission = SHX_looming_gmj_coup
	remove_ideas = SHX_guominjun_unrest_idea
	remove_power_balance = { id = SHX_power_balance }

	country_event = { id = shx_powerstruggle.4 days = 1 } #The Shanxi Government Toppled!

	if = {
		limit = { SHX = { is_subject_of = QIE } }
		china_break_puppet_effect = yes
		effect_tooltip = {
			QIE = {
				create_wargoal = {
					target = SHX
					type = annex_everything
				}
			}
		}
	}

	hidden_effect = {
		QIE = {
			country_event = { id = shx_zhifeng.2 days = 7 } #QIE is informed of outcome of Yan power struggle
		}
	}
	mark_focus_tree_layout_dirty = yes #to display the allow branch focuses
}

### SHX Purges

SHX_feng_army_purged = {
	hidden_effect = { #Keep this high because otherwise the below unit leaders will vanish
		random_country = { #Han Fuju ends up going eastwards
			limit = {
				china_is_aligned_with_fengtian = yes
				OR = {
					is_ai = no #Give Player tags priority
					AND = {
						FNG = { is_ai = yes }
						ANQ = {
							OR = {
								is_ai = yes
								china_is_aligned_with_fengtian = no
							}
						}
						SQI = {
							OR = {
								is_ai = yes
								china_is_aligned_with_fengtian = no
							}
						}
						GXC = {
							OR = {
								is_ai = yes
								china_is_aligned_with_fengtian = no
							}
						}
					}
				}
			}
			SHX = {
				SHX_han_fuju = {
					remove_military_advisor_roles = yes
					set_nationality = PREV.PREV
					unit_leader_event = {
						id = shx_powerstruggle.11 #The Lost Taibao
						days = 1
					}
				}
			}
		}
		if = {
			limit = {
				any_of_scopes = {
					array = global.china_tags_array
					exists = yes
					china_is_potential_government = yes
					china_is_aligned_with_republicans = yes
					is_ai = no
				}
			}
			random_other_country = {
				limit = {
					china_is_potential_government = yes
					china_is_aligned_with_republicans = yes
					is_ai = no
				}
				SHX = {
					SHX_sun_lianzhong = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_zhang_zizhong = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_song_zheyuan = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_feng_anbang = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
				}
				country_event = { id = shx_powerstruggle.10 days = 1 } #Exiles from Shanxi
			}
		}
		else = {
			random_other_country = {
				limit = {
					china_is_potential_government = yes
					china_is_aligned_with_republicans = yes
				}
				SHX = {
					SHX_sun_lianzhong = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_zhang_zizhong = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_song_zheyuan = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
					SHX_feng_anbang = {
						remove_military_advisor_roles = yes
						set_nationality = PREV.PREV
					}
				}
				country_event = { id = shx_powerstruggle.10 days = 1 } #Exiles from Shanxi
			}
		}
		custom_effect_tooltip = characters_will_be_retired
		character_list_tooltip = {
			limit = {
				OR = {
					AND = {
						is_unit_leader = yes
						has_trait = SHX_gmj_officer
					}
					is_character = SHX_zhang_zhijiang
					is_character = SHX_lu_zhonglin
					is_character = SHX_cao_baoqing
					is_character = SHX_xie_wenda
					is_character = SHX_shen_dexie
					is_character = SHX_hu_jingyi
					is_character = SHX_han_duofeng
					is_character = SHX_shi_jingting
					is_character = SHX_liu_yufen
				}
			}
		}
		hidden_effect = {
			SHX_zhang_zhijiang = {
				remove_military_advisor_roles = yes
			}
			SHX_lu_zhonglin = {
				remove_military_advisor_roles = yes
			}
			SHX_cao_baoqing = {
				remove_military_advisor_roles = yes
			}
			SHX_xie_wenda = {
				remove_military_advisor_roles = yes
			}
			SHX_shen_dexie = {
				remove_military_advisor_roles = yes
			}
			SHX_hu_jingyi = {
				remove_military_advisor_roles = yes
			}
			SHX_han_duofeng = {
				remove_military_advisor_roles = yes
			}
			SHX_shi_jingting = {
				remove_military_advisor_roles = yes
			}
			SHX_liu_yufen = {
				remove_military_advisor_roles = yes
			}
			every_unit_leader = {
				limit = { has_trait = SHX_gmj_officer }
				remove_unit_leader_role = yes
				remove_military_advisor_roles = yes
			}
		}
	}
}

SHX_yan_army_purged = {
	hidden_effect = {
		608 = { #owner of Beijing
			owner = {
				if = {
					limit = { is_chinese_tag = yes }
					SHX = {
						SHX_zhao_chengshou = {
							remove_military_advisor_roles = yes
							set_nationality = PREV.PREV
						}
						SHX_li_fuying = {
							remove_military_advisor_roles = yes
							set_nationality = PREV.PREV
						}
						SHX_wang_jingguo = {
							remove_military_advisor_roles = yes
							set_nationality = PREV.PREV
						}
						SHX_yang_aiyuan = {
							remove_military_advisor_roles = yes
							set_nationality = PREV.PREV
						}
					}
					country_event = { id = shx_powerstruggle.10 days = 1 } #Exiles from Shanxi
				}
			}
		}
	}
	custom_effect_tooltip = characters_will_be_retired
	character_list_tooltip = {
		limit = {
			OR = {
				AND = {
					NOT = { is_character = SHX_shang_zhen }
					is_unit_leader = yes
					has_trait = SHX_yan_loyalist
				}
				is_character = SHX_zhong_jihan
				is_character = SHX_an_chang_nam
				is_character = SHX_zhu_shouguang
			}
		}
	}
	hidden_effect = {
		SHX_zhong_jihan = {
			remove_military_advisor_roles = yes
		}
		SHX_an_chang_nam = {
			remove_military_advisor_roles = yes
		}
		SHX_zhu_shouguang = {
			remove_military_advisor_roles = yes
		}
		every_unit_leader = {
			limit = {
				has_trait = SHX_yan_loyalist
				NOT = { is_character = SHX_shang_zhen }
			}
			remove_unit_leader_role = yes
			remove_military_advisor_roles = yes
		}
	}
}

###Advisor Effects
SHX_new_sic_effect = {
	hidden_effect = {
		ROOT = {
			if = {
				limit = { original_tag = SHX }
				country_event = { id = SHX.advisor.18 days = 3 } #A New Right Hand?
			}
		}
	}
}

####################
####- Beijing - ####
###- Investment - ##
####################

###- Beijing Influence Levels -###
SHX_econ_update = {
	hidden_effect = {
		SHX_remove_qie_econ = yes
		if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 90 } }
			add_ideas = SHX_qie_influence_idea4
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 60 } }
			add_ideas = SHX_qie_influence_idea3
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 30 } }
			add_ideas = SHX_qie_influence_idea2
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 10 } }
			add_ideas = SHX_qie_influence_idea1
		}
		else = { add_ideas = SHX_qie_influence_idea0 }
	}
}

SHX_marlib_change_pop_effect = {
	set_temp_variable = { SHX_marlib_change_pop_var = SHX_QIE_inf_change_var }
	multiply_temp_variable = { SHX_marlib_change_pop_var = 0.01 } #Turn it into a decimal
	multiply_temp_variable = { SHX_marlib_change_pop_var = 0.33 } #Third it
	add_popularity = {
		ideology = market_liberal
		popularity = SHX_marlib_change_pop_var
	}
}

SHX_QIE_investment_change_inf_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_influence_variable
		value = SHX_QIE_inf_change_var
	}
	clamp_variable = {
		var = SHX.SHX_QIE_influence_variable
		min = 0
		max = 100
	}
	SHX_econ_update = yes
}

SHX_QIE_investment_small = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 5 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_small_tooltip
		log = "SHX_influence_logging; investment increase by +5 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_investment_medium = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 10 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_medium_tooltip
		log = "SHX_influence_logging; investment increase by +10 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_investment_large = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 15 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_large_tooltip
		log = "SHX_influence_logging; investment increase by +15 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_investment_giga = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 30 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_giga_tooltip
		log = "SHX_influence_logging; investment increase by +30 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_spend_small = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -5 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_small_tooltip
		log = "SHX_influence_logging; investment decrease by -5 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_spend_medium = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -10 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_medium_tooltip
		log = "SHX_influence_logging; investment decrease by -10 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_spend_large = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -15 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_large_tooltip
		log = "SHX_influence_logging; investment decrease by -15 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_spend_giga = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -30 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_giga_tooltip
		log = "SHX_influence_logging; investment decrease by -30 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_remove_qie_econ = {
	if = {
		limit = { has_idea = SHX_qie_influence_idea0 }
		remove_ideas = SHX_qie_influence_idea0
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea1 }
		remove_ideas = SHX_qie_influence_idea1
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea2 }
		remove_ideas = SHX_qie_influence_idea2
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea3 }
		remove_ideas = SHX_qie_influence_idea3
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea4 }
		remove_ideas = SHX_qie_influence_idea4
	}
}

###- QIE Negotiations and Zhifeng -###
SHX_QIE_negotiation_demand_plus_1_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 1
		tooltip = SHX_QIE_negotiation_demand_plus_1_tooltip
	}
}

SHX_QIE_negotiation_demand_plus_2_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 2
		tooltip = SHX_QIE_negotiation_demand_plus_2_tooltip
	}
}

SHX_QIE_negotiation_demand_plus_3_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 3
		tooltip = SHX_QIE_negotiation_demand_plus_3_tooltip
	}
}

SHX_QIE_negotiation_demand_minus_1_effect = {
	subtract_from_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 1
		tooltip = SHX_QIE_negotiation_demand_minus_1_tooltip
	}
}

SHX_QIE_negotiation_demand_minus_2_effect = {
	subtract_from_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 2
		tooltip = SHX_QIE_negotiation_demand_minus_2_tooltip
	}
}

SHX_transfer_east_shanxi_effect = {
	if = {
		limit = { 615 = { is_fully_controlled_by = QIE } }
		transfer_state = 615 #Eastern Shanxi
	}
	else = { set_state_owner = 615 } #Eastern Shanxi
}

SHX_transfer_guanzhong_effect = {
	if = {
		limit = { 799 = { is_fully_controlled_by = QIE } }
		transfer_state = 799 #Guanzhong (Xi'an)
	}
	else = { set_state_owner = 799 } #Guanzhong (Xi'an)
	add_state_core = 799 #Guanzhong (Xi'an)
}

SHX_QIE_negotiation_accept_effect = {

	set_global_flag = SHX_deal_QIE

	SHX = {
		set_country_flag = SHX_QIE_negotiations_succeed
		complete_national_focus = SHX_recognize_gov
		country_event = { id = shx_zhifeng.17 days = 1 } #Inform them of the SHX-QIE alliance
	}

	if = {
		limit = {
			check_variable = { #Activate Scenario 1 - SHX gets demilitarized East Shanxi
				SHX.SHX_QIE_negotiation_value = 1
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_1
			QIE = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				give_resource_rights = {
					receiver = QIE
					state = 615
				}
				if = {
					limit = {
						has_war = no
					}
					615 = {
						set_demilitarized_zone = yes
					}
				}
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 2 - SHX gets East Shanxi
				SHX.SHX_QIE_negotiation_value = 2
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_2
			QIE = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 3 - SHX gets Guanzhong (Xi'an)
				SHX.SHX_QIE_negotiation_value = 3
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_3
			QIE = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_guanzhong_effect = yes
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 4 - SHX gets East Shanxi and Guanzhong (Xi'an)
				SHX.SHX_QIE_negotiation_value = 4
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_4
			QIE = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				SHX_transfer_guanzhong_effect = yes
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 5 - SHX gets East Shanxi and Guanzhong (Xi'an) + Claims on Suiyuan
				SHX.SHX_QIE_negotiation_value = 5
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_5
			QIE = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				country_event = shx_zhifeng.16 #Inform both parties of what just happened
				SHX_transfer_east_shanxi_effect = yes
				SHX_transfer_guanzhong_effect = yes
				add_state_claim = 616 #Ordos
				add_state_claim = 621 #Ulanqab
			}
		}
	}

	else = {
		hidden_effect = {
			QIE = {
				country_event = shx_zhifeng.16 #Inform there's been an error - Scenario 2 loaded
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				country_event = shx_zhifeng.16 #Inform there's been an error - Scenario 2 loaded
			}
		}
	}

	custom_effect_tooltip = SHX_QIE_negotiation_accept_tooltip
	clear_variable = SHX.SHX_QIE_negotiation_value

}

###- Misc Beijing Effects -###
SHX_convert_influence_to_war_support_effect = {
	custom_effect_tooltip = SHX_convert_inf_to_ws_tooltip
	set_temp_variable = { SHX_War_Support = SHX_QIE_influence_variable }
	divide_temp_variable = { SHX_War_Support = 100 }
	divide_temp_variable = { SHX_War_Support = -2 }
	add_war_support = SHX_War_Support
	set_variable = { SHX_QIE_influence_variable = 0 }
	clr_country_flag = Shanxi_open_for_investment
}

SHX_set_up_QIE_influence_game = {
	set_country_flag = SHX_paying_with_inf
	QIE = { set_country_flag = QIE_influence_shanxi_available }
	SHX_econ_update = yes
}

SHX_negotiate_econ_treaty = {
	if = {
		limit = { has_idea = SHX_qie_influence_idea4 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea4
			add_idea = SHX_qie_dominated_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea3 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea3
			add_idea = SHX_qie_prevelant_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea2 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea2
			add_idea = SHX_qie_equal_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea1 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea1
			add_idea = SHX_qie_shx_dominated_econ
		}
	}
	else = { remove_ideas = SHX_qie_influence_idea0 }
}

####################
####- Warfare - ####
####################

###- Zhifeng War -###
SHX_attack_QIE_effect = { #effect to run when SHX attacks QIE - might be good to add it to an on_action if players try and bypass using justify
	608 = {
		owner = {
			SHX = {
				declare_war_on = {
					target = PREV
					type = annex_everything
				}
				if = {
					limit = {
						NOT = {
							has_active_mission = SHX_collapse_of_shanxi
							has_completed_focus = SHX_national_leadership
						}
						any_neighbor_country = { controls_state = 608 }
					}
					effect_tooltip = { activate_mission = SHX_collapse_of_shanxi } #The actual effect is an on-action
					custom_effect_tooltip = tooltip_white_line
				}
				if = {
					limit = { PREV = { tag = QIE } }
					QIE = { setup_decision_attack_AI = yes }
					SHX_convert_influence_to_war_support_effect = yes
					custom_effect_tooltip = tooltip_white_line
					add_ideas = SHX_war_of_liberation
				}
				else_if = {
					limit = { PREV = { tag = FNG } }
					add_ideas = SHX_war_of_liberation
				}
			}
		}
	}
	if = {
		limit = {
			OR = {
				has_active_mission = SHX_educational_reform_mission_timer
				has_active_mission = SHX_agricultural_reform_mission_timer
				has_active_mission = SHX_industrial_reform_mission_timer
			}
		}
		country_event = { id = shx_zhifeng.27 days = 5 } #War Disrupts Our Reforms
	}
	SHX_remove_all_joint_strike_decisions = yes
}

SHX_JAP_infiltration_effect = {
	if = {
		limit = {
			has_dlc_lar = yes
		}
		#No Need to Check for Komoto Daisaku since him being hired is the crux of this entire event chain.
		#Su Tiren, Yan Xishan's Secretary
		if = {
			limit = {
				SHX = {
					SHX_su_tiren = { is_political_advisor = no }
					SHX_su_tiren = { is_second_in_command = no }
				}
			}
			add_intel = {
				target = SHX
				civilian_intel = 10
			}
		}
		else = {
			add_intel = {
				target = SHX
				civilian_intel = 25
				army_intel = 10
			}
		}
		#Feng Sizhi and Nan Peilang, Commissioner of Police and Chief of the Shanxi People's Political Supervisorial Association
		if = {
			limit = {
				SHX = {
					SHX_feng_sizhi = { is_political_advisor = no }
					SHX_feng_sizhi = { is_second_in_command = no }
				}
			}
			add_intel = {
				target = SHX
				civilian_intel = 10
			}
		}
		else = {
			add_intel = {
				target = SHX
				civilian_intel = 25
				army_intel = 10
			}
		}
		#Han Fuju
		if = {
			limit = {
				SHX = {
					SHX_han_fuju = {
						NOT = {
							is_leading_army = yes
							is_leading_army_group = yes
						}
					}
				}
			}
			add_intel = {
				target = SHX
				army_intel = 10
			}
		}
		else = {
			add_intel = {
				target = SHX
				army_intel = 30
			}
		}
		if = {
			limit = {
				SHX = {
					SHX_han_fuju = {
						NOT = {
							is_high_command = yes
							is_army_chief = yes
						}
					}
				}
			}
			add_intel = {
				target = SHX
				army_intel = 5
			}
		}
		else = {
			add_intel = {
				target = SHX
				army_intel = 20
				airforce_intel = 30
			}
		}
		#Liu Yufeng
		if = {
			limit = {
				SHX = {
					SHX_liu_yufen = {
						NOT = {
							is_high_command = yes
							is_army_chief = yes
						}
					}
				}
			}
			add_intel = {
				target = SHX
				army_intel = 5
			}
		}
		else = {
			add_intel = {
				target = SHX
				army_intel = 10
			}
		}
	}
	else = {
		add_decryption = {
			target = SHX
			ratio = 0.25
		}
	}
}

SHX_add_flag_modifier = {
	if = {
		limit = { has_variable = SHX_states_available_for_setting_plans }
		for_loop_effect = {
			start = SHX_states_available_for_setting_plans
			end = 4
			random_scope_in_array = {
				array = SHX_zhifeng_targets_array
				limit = {
					has_state_flag = SHX_war_plan_flagged_state
					NOT = { has_dynamic_modifier = { modifier = SHX_war_plan_modifier } }
					THIS.owner = { has_war_with = SHX }
				}
				add_dynamic_modifier = { modifier = SHX_war_plan_modifier }
				if = {
					limit = {
						SHX = { has_completed_focus = SHX_cloak_dagger }
						has_resistance = no
					}
					force_enable_resistance = { occupier = QIE }
					start_resistance = yes
				}
			}
		}
	}
}

SHX_remove_flag_modifier = { #for use once war is over to clear out all of the planning effects, flags, array and Vars
	if = {
		limit = { has_variable = SHX_states_available_for_setting_plans }
		for_loop_effect = {
			start = SHX_states_available_for_setting_plans
			end = 4
			random_scope_in_array = {
				array = SHX_zhifeng_targets_array
				limit = {
					has_state_flag = SHX_war_plan_flagged_state
				}
				remove_dynamic_modifier = { modifier = SHX_war_plan_modifier }
				force_enable_resistance = { occupier = QIE clear = yes }
			}
		}
		clear_array = SHX_zhifeng_targets_array
		clear_variable = SHX_states_available_for_setting_plans
		clear_variable = SHX_war_plan_supplies_modifier
		clear_variable = SHX_war_plan_org_rate_modifier
		clear_variable = SHX_war_plan_speed_modifier
		clear_variable = SHX_war_plan_resistance_target
	}

}

SHX_convert_flag_modifier = { #for use when SHX captured a state they flagged - replaces modifier with bonuses if any
	if = {
		limit = { has_dynamic_modifier = { modifier = SHX_war_plan_modifier } }
		SHX = {
			if = {
				limit = { has_completed_focus = SHX_the_peoples_army } #spawn divisions
				if = {
					limit = {
						NOT = { has_template = "Sacrifice League" } ##placeholder name based on 牺牲救国同盟会
					}
					division_template = {
						name = "Sacrifice League"
						division_names_group = CHYN_MIL_01
						regiments = {
							irregular_infantry = { x = 0 y = 0 }
							irregular_infantry = { x = 0 y = 1 }
							irregular_infantry = { x = 1 y = 0 }
							irregular_infantry = { x = 1 y = 1 }
						}
						priority = 0
					}
				}
				PREV = {
					create_unit = {
						division = "division_template = \"Sacrifice League\" start_experience_factor = 0.05 start_equipment_factor = 0.75"
						owner = SHX
						allow_spawning_on_enemy_provs = no
						count = 1
					}
				}
			}
			if = {
				limit = { has_completed_focus = SHX_an_army_that_labours } #give compliance
				PREV = {
					add_compliance = 30
				}
			}
		}
		remove_dynamic_modifier = { modifier = SHX_war_plan_modifier }
		force_enable_resistance = { occupier = QIE clear = yes }
		clr_state_flag = SHX_war_plan_flagged_state
	}
}

###- Suiyuan Effects -###

SHX_seize_suiyuan_effect = {
	if = {
		limit = { ROOT = { owns_state = 616 }} #Ordos
		616 = { transfer_state_to = SHX }
	}
	if = {
		limit = { ROOT = { owns_state = 621 }} #Ulanqab
		621 = { transfer_state_to = SHX }
	}
	if = {
		limit = {
			owns_state = 612 #Northern Chahar
			330 = { owner = { NOT = { tag = ROOT } } } #If Mongolia isn't also owned by (directly or indirectly) whoever Suiyuan is being stolen from, will steal Northern Chahar as well)
		}
		612 = { transfer_state_to = SHX }
		custom_effect_tooltip = SHX_suiyuan_warn_loss_of_chahar_to_SHX_tooltip
	}
	else_if = { #Basically if XSM vassalized Mongolia and loses Suiyuan, Northern Chahar goes to Mongolia to avoid border gore
		limit = {
			owns_state = 612 #Northern Chahar
			MON = { is_subject_of = ROOT }
		}
		330 = { transfer_state_to = MON }
		custom_effect_tooltip = SHX_suiyuan_warn_loss_of_chahar_to_MON_tooltip
	}
	add_opinion_modifier = {
		target = SHX
		modifier = KR_outraged
	}
	reverse_add_opinion_modifier = {
		target = SHX
		modifier = KR_returned_land
	}
	if = {
		limit = {
			SHX = {
				has_idea = SHX_suiyuan_QIE_neutrality
			}
		}
		remove_ideas = SHX_suiyuan_QIE_neutrality
	}
}

SHX_start_suiyuan_crisis = {
	add_ideas = SHX_suiyuan_QIE_neutrality #Keep Shanxi from calling in allies
	activate_mission = SHX_march_on_suiyuan_mission
	activate_mission_tooltip = SHX_march_on_suiyuan_mission
	#activate all related decisions
	if = {
		limit = { var:616.owner = { NOT = { tag = SHX } } }
		activate_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_begin_northwestern_expedition }
		activate_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_send_scouts_to_enemy }
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_gather_supplies }
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_decisive_first_strike_decision }
	}
	if = {
		limit = { var:616.owner = { is_chinese_tag = no } }
		activate_targeted_decision = { target = var:616.owner decision = SHX_prepare_hui_provisional_leaders }
	}
	#activate decisions on enemy side
	var:616.owner = {#Ordos
		country_event = shx_suiyuan_campaign.31 #Shanxi mobilises for Suiyuan!
		activate_mission = SHX_march_on_suiyuan_mission
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
		activate_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
		activate_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
		if = {
			limit = {
				is_guaranteed_by = TIB
			}
			TIB = {
				country_event = shx_suiyuan_campaign.31
				activate_mission = SHX_march_on_suiyuan_mission
				activate_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
				activate_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
				activate_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
				activate_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
			}
		}
		if = { #allow Shanxi's enemy to destablized them in Gansu if they own it
			limit = { SHX = { owns_state = 283 } } #Lanzhou
			activate_targeted_decision = { target = 283 decision = SHX_suiyuan_destabilise_province }
		}
	}
	country_event = shx_suiyuan_campaign.36
	616 = { save_global_event_target_as = SHX_targeted_state }
}

#effect to remove all of the pre war decisions - fired if they either go to war, or if crisis defuses through other means
SHX_end_suiyuan_crisis = {
	hidden_effect = {
		if = {
			limit = { tag = SHX }
			remove_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_begin_northwestern_expedition }
			remove_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_send_scouts_to_enemy }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_gather_supplies }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_decisive_first_strike_decision }
			remove_targeted_decision = { target = var:616.owner decision = SHX_prepare_hui_provisional_leaders }
		}
		else = {
			remove_mission = SHX_march_on_suiyuan_mission
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
			remove_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
			remove_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
		}
	}
}

SHX_suiyuan_campaign_prep_add_small = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 30
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_small_tooltip
}

SHX_suiyuan_campaign_prep_add_medium = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 50
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_medium_tooltip
}

SHX_suiyuan_campaign_prep_add_large = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 100
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_large_tooltip
}

SHX_suiyuan_campaign_prep_subtract_small = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -30
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_small_tooltip
}

SHX_suiyuan_campaign_prep_subtract_medium = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -50
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_medium_tooltip
}

SHX_suiyuan_campaign_prep_subtract_large = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -100
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_large_tooltip
}

SHX_suiyuan_campaign_tally_success_effect = {
	set_variable = {
		var = SHX_suiyuan_claimed_states_unfulfilment_variable
		value = SHX_suiyuan_claimed_states_variable
	}
	if = {
		limit = { owns_state = 616 } #Ordos
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 621 } #Ulanqab
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 348 } #Ningxia
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 604 } #Xining
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 353 } #Yushu
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
}

SHX_remove_all_joint_strike_decisions = {
	remove_targeted_decision = { target = FNG decision = SHX_joint_strike_decision }
	remove_targeted_decision = { target = GXC decision = SHX_joint_strike_decision }
	remove_targeted_decision = { target = CHI decision = SHX_joint_strike_decision }
	remove_targeted_decision = { target = SZC decision = SHX_joint_strike_decision }
	remove_targeted_decision = { target = YUN decision = SHX_joint_strike_decision }
}

SHX_add_join_government_decisions = {
	if = { # Feng only ones
		limit = { has_country_leader = { character = SHX_feng_yuxiang } }
		if = { #LKMT
			limit = { CHI = { china_is_valid_government_to_join = yes } }
			activate_targeted_decision = { target = CHI decision = SHX_join_government }
		}
		if = { #Feds
			limit = { country_exists = UPC }# needed a check if NPA exists so it wont give errors on scoping to it
			if = {
				limit = { UPC = { china_is_valid_government_to_join = yes } }
				activate_targeted_decision = { target = UPC decision = SHX_join_government }
			}
		}
	}
	else = { # Yan only ones
		if = { # Fengtian
			limit = { FNG = { china_is_valid_government_to_join = yes } }
			activate_targeted_decision = { target = FNG decision = SHX_join_government }
		}
	}
	if = { # check for YUN RKMT first since they take leader
		limit = {
			YUN = {
				china_is_valid_government_to_join = yes
				china_is_aligned_with_right_kmt = yes
			}
		}
		activate_targeted_decision = { target = YUN decision = SHX_join_government }
	}
	else_if = { # check for GXC RKMT second
		limit = {
			GXC = {
				china_is_valid_government_to_join = yes
				china_is_aligned_with_right_kmt = yes
			}
		}
		activate_targeted_decision = { target = GXC decision = SHX_join_government }
	}
	if = { # NPA
		limit = { country_exists = NPA }#needed a check if NPA exists so it wont give errors on scoping to it
		if = {
			limit = { NPA = { china_is_valid_government_to_join = yes } }
			activate_targeted_decision = { target = NPA decision = SHX_join_government }
		}
	}
}

SHX_remove_all_join_government_decisions = {
	if = {
		limit = { country_exists = UPC }
		remove_targeted_decision = { target = UPC decision = SHX_join_government }
	}
	if = {
		limit = { country_exists = NPA }
		remove_targeted_decision = { target = NPA decision = SHX_join_government }
	}
	else = {
		remove_targeted_decision = { target = FNG decision = SHX_join_government }
		remove_targeted_decision = { target = CHI decision = SHX_join_government }
		remove_targeted_decision = { target = GXC decision = SHX_join_government }
		remove_targeted_decision = { target = YUN decision = SHX_join_government }
	}
}

SHX_vanguard_claim_effect = {
	#Scope should be tag
	if = {
		limit = { THIS = { NOT = { is_ally_with = QIE } } }
		THIS = {
			every_core_state = { add_claim_by = SHX }
			SHX = { activate_targeted_decision = { target = PREV decision = china_attack_decision } }
		}
	}
}

SHX_set_NCPC_cosmetic_effect = {
	if = {
		limit = { has_cosmetic_tag = SHX_KMT }
		set_cosmetic_tag = SHX_NCPC_KMT
	}
	else = {
		set_cosmetic_tag = SHX_NCPC
	}
}

SHX_vanguard_wargoals_effect = {
	if = {
		limit = {
			SHX_no_cosmetic_flag_check = yes
		}
		SHX_set_NCPC_cosmetic_effect = yes
	}
	MON = { SHX_vanguard_claim_effect = yes }
	TIB = { SHX_vanguard_claim_effect = yes }
	KUM = { SHX_vanguard_claim_effect = yes }
	SIK = { SHX_vanguard_claim_effect = yes }
	ETS = { SHX_vanguard_claim_effect = yes }
	XSM = { SHX_vanguard_claim_effect = yes }
}

###- Manchu Coup -###
#########################
####- Manchu Coup - #####
#########################

SHX_manchu_set_up_starting_positions_effect = {
	QIE = {
		hidden_effect = {
			remove_opinion_modifier = {
				target = SHX
				modifier = KR_friendly
			}
		}
		set_province_controller = 1115
		set_province_controller = 1962
		set_province_controller = 4174
		set_province_controller = 10838
		if = {
			limit = { NOT = { has_template = "Fangong Baoweituan" } }
			division_template = {
				name = "Fangong Baoweituan" #PLACEHOLDER - historically it was the Anti-Communist Militia - might want to look up "Anti-Socialist"
				division_names_group = CHYN_MIL_01
				regiments = {
					militia = { x = 0 y = 0 }
					militia = { x = 0 y = 1 }
					militia = { x = 0 y = 2 }
					militia = { x = 1 y = 0 }
					militia = { x = 1 y = 1 }
					militia = { x = 1 y = 2 }
				}
			}
		}
		hidden_effect = {
			1072 = {
				teleport_armies = {
					limit = { tag = SHX }
					to_state = 1072 #Every SHX division in Taiyuan goes to the rest of Western Shanxi
				}
				create_unit = {
					division = "name = \"Taiyuan Anti-Socialist Militia\" division_template = \"Fangong Baoweituan\" start_experience_factor = 0.60"
					owner = QIE
				}
				if = {
					limit = { SHX = { has_country_flag = SHX_took_payout_flag } } #Lol I bet you thought this decision was inconsequential
					create_unit = {
						division = "name = \"Taiyuan Merchants' Militia\" division_template = \"Fangong Baoweituan\" start_experience_factor = 0.60"
						owner = QIE
					}
				}
			}
			every_owned_state = {
				teleport_armies = {
					limit = { tag = SHX }
					to_state = 622 #Every other QIE division in SHX territory goes to Yulin
				}
			}
		}
		SHX = {
			hidden_effect = {
				remove_opinion_modifier = {
					target = QIE
					modifier = KR_friendly
				}
			}
			add_timed_idea = {
				idea = SHX_war_of_liberation
				days = 30
			}
			if = {
				limit = { NOT = { has_completed_focus = SHX_mountains_our_home } }
				complete_national_focus = SHX_mountains_our_home
			}
			else = {
				if = {
					limit = { NOT = { has_template = "GMJ Shandi Shi" } }
					division_template = {
						name = "GMJ Shandi Shi"
						division_names_group = CHYN_INF_01
						regiments = {
							mountaineers = { x = 0 y = 0 }
							mountaineers = { x = 0 y = 1 }
							mountaineers = { x = 1 y = 0 }
							mountaineers = { x = 1 y = 1 }
						}
						support = {
							recon = { x = 0 y = 0 }
						}
					}
				}
				1072 = {
					create_unit = {
						division = "name = \"Guominjun Reservists\" division_template = \"GMJ Shandi Shi\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 1531
					}
				}
			}
			if = {
				limit = { NOT = { has_template = "Guomindang Minbing" } }
				division_template = {
					name = "Guomindang Minbing" #KMT Militia
					division_names_group = CHYN_MIL_01
					regiments = {
						militia = { x = 0 y = 0 }
						militia = { x = 0 y = 1 }
						militia = { x = 0 y = 2 }
						militia = { x = 1 y = 0 }
						militia = { x = 1 y = 1 }
						militia = { x = 1 y = 2 }
					}
				}
			}
			1072 = {
				create_unit = {
					division = "name = \"Shang Clique Defectors\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
					owner = SHX
					prioritize_location = 1531
				}
				if = {
					limit = { SHX = { NOT = { has_country_flag = SHX_took_payout_flag } } } #Lol and you thought stoking resistance was worthless
					create_unit = {
						division = "name = \"Kuomintang (RF) Defectors\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 10367
					}
					create_unit = {
						division = "name = \"Student Association Radicals\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 12300
					}
				}
				add_resistance = 80 #Get it high to balance out QIE
			}
			SHX_yan_xishan = {
				add_advisor_role = {
					advisor = {
						slot = army_chief
						idea_token = SHX_yan_xishan_army_chief
						traits = { KR_army_chief_imperial_commissioner } #KR_army_chief_entrenchment_2
						cost = 0
						can_be_fired = no
					}
				}
				set_nationality = QIE
				QIE = {
					activate_advisor = SHX_yan_xishan_army_chief
				}
			}
			SHX_wang_xiang = {
				remove_second_in_command_role = yes
				set_nationality = QIE
			}
			SHX_liang_huazhi = {
				remove_all_country_leader_roles = yes
				remove_second_in_command_role = yes
				add_corps_commander_role = {
					desc = SHX_liang_huazhi_desc
					traits = { media_personality politically_connected }
					skill = 2
					attack_skill = 2
					defense_skill = 2
					planning_skill = 2
					logistics_skill = 1
				}
				set_nationality = QIE
			}
			SHX_zhao_daiwen = {
				remove_second_in_command_role = yes
				set_nationality = QIE
			}
			SHX_su_tiren = {
				remove_second_in_command_role = yes
				set_nationality = QIE
			}
			SHX_feng_sizhi = { set_nationality = QIE }
		}
	}
	SHX = {
		set_capital = { state = 622 remember_old_capital = no } #Keeps the capital in Yulin, post-war event will allow you to decide whether or not to move the capital.
		country_event = { id = shx_manchu.7 days = 2 } #An Emergency Capital.
		swap_ideas = {
			remove_idea = SHX_dual_armies
			add_idea = SHX_integrated_army
		}
		unlock_national_focus = SHX_integrate_the_armies
		hidden_effect = {
			add_country_leader_role = {
				character = SHX_jia_jingde
				promote_leader = yes
				country_leader = {
					ideology = market_liberal_subtype
				}
			}
			add_country_leader_role = {
				character = SHX_jia_jingde
				promote_leader = yes
				country_leader = {
					ideology = paternal_autocrat_subtype
				}
			}
			add_country_leader_role = {
				character = SHX_jia_jingde
				promote_leader = yes
				country_leader = {
					ideology = national_populist_subtype
				}
			}
			set_party_name = { #Rename Feng's Party from GMJ to National Party
				ideology = paternal_autocrat
				long_name = SHX_jia_jingde_remnant_party_long
				name = SHX_jia_jingde_remnant_party
			}
		}
	}
}

SHX_manchu_set_up_timer_effect = {
	QIE = {
		activate_mission = QIE_eyes_on_the_border
		activate_mission = QIE_SHX_intervention
		custom_effect_tooltip = QIE_SHX_intervention_tooltip
	}
	SHX = {
		activate_mission = QIE_SHX_intervention_visual_only
	}
}

SHX_manchu_gmj_leadership_activation = {
	hidden_effect = {
		SHX_lu_zhonglin = { set_nationality = ROOT }
		SHX_liu_yufen = { set_nationality = ROOT }
		SHX_han_duofeng = { set_nationality = ROOT }
		SHX_feng_anbang = { set_nationality = ROOT }
	}
	custom_effect_tooltip = SHX_characters_will_added_to_MHC
}

SHX_manchu_coup_setup_effect = {
	SHX_manchu_set_up_starting_positions_effect = yes
	SHX_manchu_gmj_leadership_activation = yes
	SHX_convert_influence_to_war_support_effect = yes
	SHX_remove_qie_econ = yes
	complete_national_focus = SHX_destiny
	add_command_power = 100
	declare_war_on = {
		target = QIE
		type = take_claimed_state
		generator = { 1072 615 }
	}
	SHX_manchu_set_up_timer_effect = yes
	hidden_effect = { news_event = shx_manchu.11 } #The Central Plains War
}

SHX_manchu_state_transfer_effect = {
	#Initial Scope should be a state
	if = {
		limit = { is_owned_by = QIE }
		transfer_state_to = SHX
	}
	else_if = {
		limit = { is_owned_by = SHX }
		transfer_state_to = QIE
	}
}

SHX_manchu_peace_effect = {
	#Check to see progress in the northern front
	if = {
		limit = { QIE = { controls_state = 1072 } } #Western Shanxi - starts off in SHX ownership
		1072 = { SHX_manchu_state_transfer_effect = yes }
	}
	else_if = {
		limit = { SHX = { controls_state = 615 } } #Eastern Shanxi - Starts off in QIE ownership
		615 = { SHX_manchu_state_transfer_effect = yes }
	}
	#Check to See Progress in the Southern Front
	if = {
		limit = { QIE = { controls_state = 799 } } #Guanzhong (Xi'an) - Starts off in SHX ownership
		799 = { SHX_manchu_state_transfer_effect = yes }
		QIE = {
			if = {
				limit = {
					controls_state = 622 #Yulin - Starts off in SHX control. This is a failsafe
					controls_state = 1072 #If QIE owns Yulin and GMJ failed to retake Taiyuan, game over for SHX
				}
				annex_country = { target = SHX }
			}
		}
	}
	else_if = {
		limit = {
			SHX = {
				controls_state = 607 #Helou - starts off in QIE ownership.
				controls_state = 1072 #West Shanxi - starts off SHX ownership
			}
		}
		607 = {
			SHX_manchu_state_transfer_effect = yes
			add_core_of = SHX
		}
	}
	QIE = {
		white_peace = SHX
		set_truce = {
			target = SHX
			days = 180
		}
		diplomatic_relation = {
			country = SHX
			relation = non_aggression_pact
		}
		reverse_add_opinion_modifier = {
			target = SHX
			modifier = KR_hostile
		}
		add_opinion_modifier = {
			target = SHX
			modifier = KR_hostile
		}
	}
}

#########################
###- Endgame Effects -###
#########################

SHX_new_republic_remove_political_spirits_effect = {
	if = {
		limit = { has_idea = SHX_order_of_the_vigilant_lion_idea }
		remove_ideas = SHX_order_of_the_vigilant_lion_idea
	}
	if = {
		limit = { has_idea = SHX_a_higher_purpose_idea }
		remove_ideas = SHX_a_higher_purpose_idea
	}
	if = {
		limit = { has_idea = SHX_stable_future_idea }
		remove_ideas = SHX_stable_future_idea
	}
	if = {
		limit = { has_idea = SHX_good_people_movement_idea }
		remove_ideas = SHX_good_people_movement_idea
	}
	if = {
		limit = { has_idea = SHX_towards_revolution_idea }
		remove_ideas = SHX_towards_revolution_idea
	}
}

SHX_new_republic_remove_military_spirits_effect = {
	if = {
		limit = { has_idea = SHX_dual_armies }
		remove_ideas = SHX_dual_armies
	}
	if = {
		limit = { has_idea = SHX_dual_armies2 }
		remove_ideas = SHX_dual_armies2
	}
	if = {
		limit = { has_idea = SHX_integrated_army }
		remove_ideas = SHX_integrated_army
	}
	if = {
		limit = { has_idea = SHX_war_of_liberation }
		remove_ideas = SHX_war_of_liberation
	}
	if = {
		limit = { has_idea = SHX_fortress_shanxi }
		remove_ideas = SHX_fortress_shanxi
	}
}

SHX_new_republic_remove_mining_spirits_effect = {
	if = {
		limit = { has_idea = SHX_private_coal }
		remove_ideas = SHX_private_coal
	}
	if = {
		limit = { has_idea = SHX_regulate_coal }
		remove_ideas = SHX_regulate_coal
	}
	if = {
		limit = { has_idea = SHX_inefficient_coal }
		remove_ideas = SHX_inefficient_coal
	}
}

SHX_new_republic_transform_industry_spirits_effect = {
	if = {
		limit = { has_idea = SHX_Ten_Year_Plan_begins }
		remove_ideas = 	SHX_Ten_Year_Plan_begins
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy }
		remove_ideas = SHX_underdeveloped_mountain_economy
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy1 }
		remove_ideas = SHX_underdeveloped_mountain_economy1
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy2 }
		remove_ideas = SHX_underdeveloped_mountain_economy2
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng
	}

	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng1 }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng1
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_1_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_1_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng2 }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng2
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_2_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_2_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_yan1 }
		remove_ideas = SHX_underdeveloped_mountain_economy_yan1
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_3_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_3_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_yan2 }
		remove_ideas = SHX_underdeveloped_mountain_economy_yan2
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_4_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_4_agriculture_3_modifier }
			}
		}
	}
}

SHX_new_republic_transform_agriculture_spirits_effect = {
	if = {
		limit = { has_idea = SHX_agriculture_reform }
		remove_ideas = SHX_agriculture_reform
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform1 }
		remove_ideas = SHX_agriculture_reform1
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform_Yan }
		remove_ideas = SHX_agriculture_reform_Yan
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform_Feng }
		remove_ideas = SHX_agriculture_reform_Feng
	}
}

SHX_new_republic = {
	hidden_effect = {
		#Political Spirits
		SHX_new_republic_remove_political_spirits_effect = yes
		#Military Spirits
		SHX_new_republic_remove_military_spirits_effect = yes
		#Mining Spirits
		SHX_new_republic_remove_mining_spirits_effect = yes

		#Industrial Spirits
		SHX_new_republic_transform_industry_spirits_effect = yes
		#Agricultural Spirits
		SHX_new_republic_transform_agriculture_spirits_effect = yes
		#remove faction alignment decisions
		SHX_remove_all_join_government_decisions = yes
	}
	hidden_effect = {
		set_country_flag = SHX_rival_government
		mark_focus_tree_layout_dirty = yes
		if = { #Failsafe
			limit = { has_active_mission = SHX_industrial_reform_mission_timer }
			remove_mission = SHX_industrial_reform_mission_timer
		}
		if = { #Failsafe
			limit = { has_active_mission = SHX_agricultural_reform_mission_timer }
			remove_mission = SHX_agricultural_reform_mission_timer
		}
		if = { #Failsafe
			limit = { has_active_mission = SHX_educational_reform_mission_timer }
			remove_mission = SHX_educational_reform_mission_timer
		}
	}
	if = {
		limit = { SHX_not_zhongyuan_flag_check = yes }
		set_cosmetic_tag = SHX_zhongyuan_gov
	}
	country_event = { id = shx_zhifeng.29 days = 2 } #The Provisional Capital for the Provisional Republic
	add_ideas = SHX_disorganised_national_army_idea
	add_ideas = SHX_disrupted_economy_idea1
	custom_effect_tooltip = SHX_new_republic_effect_tooltip
}
SHX_new_education = {
	if = {
		limit = { has_idea = SHX_enforce_truancy_idea }
		remove_ideas = SHX_enforce_truancy_idea
	}
	if = {
		limit = { has_idea = SHX_militarized_youth_schools }
		remove_ideas = SHX_militarized_youth_schools
	}
	if = {
		limit = { has_idea = SHX_unfinished_education }
		remove_ideas = SHX_unfinished_education
	}
	if = {
		limit = { has_idea = SHX_unfinished_education1 }
		remove_ideas = SHX_unfinished_education1
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_yan }
		remove_ideas = SHX_unfinished_education_yan
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_yan1 }
		remove_ideas = SHX_unfinished_education_yan1
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_feng }
		remove_ideas = SHX_unfinished_education_feng
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_feng1 }
		remove_ideas = SHX_unfinished_education_feng1
	}
}

SHX_improve_disrupted_economy_effect = {
	if = {
		limit = { has_idea = SHX_disrupted_economy_idea1 }
		swap_ideas = {
			remove_idea = SHX_disrupted_economy_idea1
			add_idea = SHX_disrupted_economy_idea2
		}
	}
	else_if = {
		limit = { has_idea = SHX_disrupted_economy_idea2 }
		swap_ideas = {
			remove_idea = SHX_disrupted_economy_idea2
			add_idea = SHX_disrupted_economy_idea3
		}
	}
	else_if = {
		limit = { has_idea = SHX_disrupted_economy_idea3 }
		remove_ideas = SHX_disrupted_economy_idea3
	}
}

SHX_national_revolution_improve_effect = {
	if = {
		limit = { has_idea = SHX_national_revolution }
		swap_ideas = {
			remove_idea = SHX_national_revolution
			add_idea = SHX_national_revolution2
		}
	}
	else_if = {
		limit = { has_idea = SHX_national_revolution2 }
		swap_ideas = {
			remove_idea = SHX_national_revolution2
			add_idea = SHX_national_revolution3
		}
	}
	else_if = {
		limit = { has_idea = SHX_national_revolution3 }
		swap_ideas = {
			remove_idea = SHX_national_revolution3
			add_idea = SHX_national_revolution4
		}
	}
	else = {
		custom_effect_tooltip = SHX_national_revolution_improve_effect_tooltip
	}
}

SHX_yans_china_improve_effect = {
	if = {
		limit = { has_idea = SHX_yans_china }
		swap_ideas = {
			remove_idea = SHX_yans_china
			add_idea = SHX_yans_china2
		}
	}
	else_if = {
		limit = { has_idea = SHX_yans_china2 }
		swap_ideas = {
			remove_idea = SHX_yans_china2
			add_idea = SHX_yans_china3
		}
	}
	else_if = {
		limit = { has_idea = SHX_yans_china3 }
		swap_ideas = {
			remove_idea = SHX_yans_china3
			add_idea = SHX_yans_china4
		}
	}
	else = {
		custom_effect_tooltip = SHX_yans_china_improve_effect_tooltip
	}
}

SHX_end_game_remove_spirits_effect = {
	if = {
		limit = { has_idea = SHX_confucian_order }
		remove_ideas = SHX_confucian_order
	}
	if = {
		limit = { has_idea = SHX_nationalist_order }
		remove_ideas = SHX_nationalist_order
	}
	if = {
		limit = { has_idea = SHX_revolutionary_army_idea }
		remove_ideas = SHX_revolutionary_army_idea
	}
}
